<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FunFart Grab - Play & Win NFT</title>
  <link rel="icon" href="https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafkreic4z6jgfbw3nyaffniqzfjfhtcvejoqjqy2rthx5uucr4xycji3km" type="image/png"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    #game-container {
      width: 800px;
      height: 600px;
      margin: 0 auto;
      background-color: #000;
    }
    #loading {
      color: #9333ea;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <h1>🎮 FunFart Grab</h1>
  <p>Play the game and win an NFT prize!</p>
  <div id="game-container"></div>
  <div id="loading">Loading game...</div>

  <!-- UMD Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@web3modal/html/dist/umd/index.js"></script>
  <script src="https://unpkg.com/@web3modal/ethereum/dist/umd/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.2/dist/phaser.js"></script>

  <script>
    (function () {
      const projectId = "15da3c431a74b29edb63198a503d45b5";

      const chains = [
        { id: 1, name: "Ethereum", rpcUrls: ["https://rpc.ankr.com/eth"] },
        { id: 137, name: "Polygon", rpcUrls: ["https://polygon-rpc.com"] }
      ];

      const metadata = {
        name: "FunFart Grab",
        description: "Mint NFTs after winning the game!",
        url: "https://digitalknuckles.github.io/FunfartMiniGrab/",
        icons: ["https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafkreic4z6jgfbw3nyaffniqzfjfhtcvejoqjqy2rthx5uucr4xycji3km"]
      };

      // Initialize Web3Modal with proper configuration
      const web3Modal = new Web3Modal.default({
        cacheProvider: true, // cache provider
        providerOptions: {
          injected: {
            display: {
              name: "Injected",
              description: "Connect with the injected provider"
            },
            package: null
          },
          walletconnect: {
            package: window.WalletConnectProvider,
            options: {
              infuraId: projectId
            }
          }
        },
        themeMode: "light",
        themeColor: "purple",
        metadata
      });

      const CONTRACT_ADDRESS = "0x7eFC729a41FC7073dE028712b0FB3950F735f9ca";
      const CONTRACT_ABI = ["function mintPrize() public"];

      // Connect wallet to Web3Modal
      async function connectWallet() {
        try {
          const provider = await web3Modal.connect();
          const web3Provider = new ethers.providers.Web3Provider(provider);
          const signer = web3Provider.getSigner();
          const address = await signer.getAddress();
          console.log("🔌 Wallet connected:", address);
          return { provider: web3Provider, signer, address };
        } catch (err) {
          console.error("Connection failed:", err);
          alert("❌ Failed to connect wallet.");
          return null;
        }
      }

      // Mint NFT
      async function mintPrizeNFT() {
        const wallet = await connectWallet();
        if (!wallet) return;
        try {
          const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, wallet.signer);
          const tx = await contract.mintPrize();
          await tx.wait();
          alert("🎉 NFT Minted Successfully!");
        } catch (err) {
          console.error("Minting error:", err);
          alert("❌ Minting failed: " + (err.reason || err.message || err));
        }
      }

      window.mintPrizeNFT = mintPrizeNFT;

      // Trigger mint when game victory event is dispatched
      document.addEventListener("gameVictory", () => {
        console.log("🎯 Victory event received! Initiating mint...");
        mintPrizeNFT();
      });

      // Phaser Game Logic
      class GameScene extends Phaser.Scene {
        constructor() {
          super("GameScene");
        }

        preload() {
          this.load.image('background', 'https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafybeic345u2ts5tz3u3xcguldwnlg3ye5wzl6o6vew7gnf6mh3du3xpnu');
          this.load.image('claw', 'https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafkreicph5dqmvlsxvn7kbpd3ipf3qaul7sunbm3zhbx5tvf3ofgecljsq');
          this.load.image('prize', 'https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafkreibyehv3juhhr7jgfblaziguedekj7skpqzndbbvd7xnj7isuxhela');
          this.load.image('victoryBg', 'https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafybeie5fzzrljnlnejrhmrqaog3z4edm5hmsncuk4kayj5zyh7edfso5q');
          this.load.image('overlay_idle', 'https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafkreie32rhyvbibeer5minlpijbri5puqq36bafszwyjnhc4ozakew3oy');
          this.load.image('overlay_left', 'https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafkreig6zkwf6swgewwmwdhuiaualqymbfpbsdc4v3j3m47syg26x3uclq');
          this.load.image('overlay_right', 'https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafkreichlj2x2l4ejoyxale7kbfmiszesglm2aftsbdnrchjy4br5q3n2e');
          this.load.image('startMenu', 'https://magenta-broad-orca-873.mypinata.cloud/ipfs/bafkreicexx7almk7jkzgd7up4uibqh2n7v6gkmeimbgoslbclc3dsndhhy');
        }

        create() {
          this.add.image(400, 300, 'background');
          // For demo: auto trigger victory after 5 seconds
          this.time.delayedCall(5000, () => {
            this.showVictoryScreen();
          });
        }

        showVictoryScreen() {
          this.add.image(400, 300, 'victoryBg');
          this.add.text(400, 150, 'You Win!', {
            fontSize: '64px',
            color: '#ffffff'
          }).setOrigin(0.5);
          document.dispatchEvent(new Event("gameVictory"));
        }
      }

      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: "game-container",
        scene: [GameScene]
      };

      window.onload = () => {
        const loadingEl = document.getElementById("loading");
        if (loadingEl) loadingEl.style.display = "none";
        new Phaser.Game(config);
      };
    })();
  </script>
</body>
</html>
